<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dosing Control</title>
    <link rel="stylesheet" href="styles/bootstrap.min.css">
    <script src="javascript/bootstrap.bundle.min.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/cron-expression-input@1.2.7/lib/cron-expression-input.min.css">
    <script src="https://unpkg.com/cronstrue@1.48.0/dist/cronstrue.min.js" async></script>
    <script src="https://unpkg.com/cron-expression-input@1.2.7/lib/cron-expression-input.min.js"></script>
    <script src="javascript/cron-converter.js"></script>
    <link rel="icon" type="image/x-icon" href="favicon/favicon.ico">

    <style>
        header {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background-color: #f0f0f0;
        }
        header a {
            text-decoration: none;
            color: #333;
            padding: 5px 10px;
        }
        .container {
        }
        .form-row {
            display: flex;
            align-items: center;
            margin-bottom: 1px;
        }
        .form-vert {
            margin: 5px;
            align-items: center;

        }
        .form-add-sch {
            margin-bottom: 6px;
            margin-left: 10px;
            align-self: end;
        }
        label, select, input, button {
            display: block;
            margin-bottom: 10px;
        }
        body {
        }


    </style>


</head>
<body>
    <nav class="navbar navbar-expand-lg bg-primary" data-bs-theme="dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="/">Dosing</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarColor01" aria-controls="navbarColor01" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarColor01">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link" href="/calibration">Calibration</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/settings">Settings</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/ota-upgrade">OTA</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>


    <ul class="nav nav-tabs" role="tablist">
        <li class="nav-item dropdown">
            <select id="pumpSelector" class="dropdown-toggle bg-body"  style="border: transparent; padding: 8px 16px; margin: 2px 0 -1px">
            </select>
        </li>

      <li class="nav-item" role="presentation">
        <a class="nav-link active" data-bs-toggle="tab" href="#dosetab" aria-selected="true" role="tab">Dose</a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" data-bs-toggle="tab" href="#schedtab" aria-selected="false" role="tab" tabindex="-1">Schedule</a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" data-bs-toggle="tab" href="#limittab" aria-selected="false" tabindex="-1" role="tab">Limits</a>
      </li>
    </ul>
    <div id="myTabContent" class="tab-content">
      <div class="tab-pane fade container active show" id="dosetab" role="tabpanel">
        <h2>Dosing Control</h2>
        <label for="amountInput">Amount (ml) to Dose:</label>
        <input type="number" id="amountInput" placeholder="Enter amount in ml">

        <label for="timeInput">Duration sec:</label>
        <input type="number" id="timeInput" placeholder="Enter time in seconds">

        <label for="directionInput">Direction:</label>
        <select id="directionInput">
            <option value="1">Clockwise</option>
            <option value="0">Counterclockwise</option>
        </select>

        <button id="doseButton" disabled>Start Dosing</button>
      </div>





      <div class="tab-pane fade container" id="schedtab" role="tabpanel">
        <p>Dosing pump schedule.</p>
          <button id="schedShowbtn" onclick="showSchedule()">Schedule program</button>
        <div class="form-border" id="scheduleDiv" style="display: none">
            <h2>Add dosing schedule</h2>
            <div class="form-row">
                <div class="form-vert">
                    <label for="myCronInput">Schedule</label>
                    <cron-expression-input id="myCronInput" height="30px" width="120px" color="d58512" required="false" hotValidate="true" value="* * * * *"></cron-expression-input>
                </div>
                <div class="form-vert">
                    <label for="schVolumeInput">Dose ml</label>
                    <input type="number" id="schVolumeInput" placeholder="Enter ml"  style="width: 100px">
                </div>

                <div class="form-vert">
                    <label for="schDurationInput" >Duration Sec</label>
                    <input type="number" id="schDurationInput"  placeholder="Enter sec" style="width: 100px">
                </div>
                <div class="form-add-sch">
                    <button type="button" onclick="addSchedule()" style="height: 20px;">Add</button>
                </div>
                <div class="form-add-sch">
                    <button type="button" onclick="uploadSchedule()" style="height: 20px;">Upload</button>
                </div>
            </div>
            <div id="scheduleFormsContainer"></div>
        </div>
      </div>







      <div class="tab-pane fade container" id="limittab">
        <p>Dosing pump limits.</p>
      </div>
    </div>









    <script>
        const numberOfPumps = 9; // Total number of pumps

        let scheduleData = {};
        for (let i = 1; i <= numberOfPumps; i++) {
            scheduleData[`pump${i}`] = [];
        }

        function showSchedule(){
            document.getElementById("scheduleDiv").style.display="block"
        }

        //Upload schedule to controller
         function uploadSchedule() {
            const url = window.location.href;
            const data = {};

            for (const [pumpKey, pumpData] of Object.entries(scheduleData)) {
                data[pumpKey] = pumpData;
            }

            console.log("upload data", data)

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
            .then(response => {
                console.log("Response:", response)
            })
            .then(data => {
                console.log('Success:', data);
            })
            .catch((error) => {
                console.error('Error:', error);
            });
        }

        function checkInputs() {
            const amountInput = document.getElementById('amountInput').value;
            const timeInput = document.getElementById('timeInput').value;
            const doseButton = document.getElementById('doseButton');

            const isAmountValid = parseFloat(amountInput) > 0;
            const isTimeValid = parseFloat(timeInput) > 0;

            doseButton.disabled = !(isAmountValid && isTimeValid);
        }

        document.getElementById('amountInput').addEventListener('input', checkInputs);
        document.getElementById('timeInput').addEventListener('input', checkInputs);

        document.getElementById('doseButton').addEventListener('click', function() {
            const pumpNumber = document.getElementById('pumpSelector').value;
            const amount = document.getElementById('amountInput').value;
            const time = document.getElementById('timeInput').value;
            const direction = document.getElementById('directionInput').value;

            // use API to start dosing
            const url = `/dose?volume=${amount}&time=${time}&direction=${direction}&id=${pumpNumber}`;

            fetch(url)
            .then(response => response.json())
            .then(data => console.log('Success:', data))
            .catch((error) => console.error('Error:', error));
        });

        checkInputs(); // Run once on page load to set initial button state


        // Add Schedule
        function addSchedule() {
            const pumpNumber = document.getElementById('pumpSelector').value
            const schVolumeInput = document.getElementById('schVolumeInput');
            const schDurationInput = document.getElementById('schDurationInput');
            if (schVolumeInput.value && schDurationInput.value){
                console.log("Add schedule for ", pumpNumber)
                var cronInput = document.getElementById(`myCronInput`);

                // Use querySelector on cronInput to find the nested input element
                var nestedInput = cronInput.querySelector('div > div:nth-child(1) > input');
                // Check if the nested input element was found
                if (nestedInput) {
                    // Get the value of the nested input element
                    var inputValue = nestedInput.value;
                    var cronstrue = window.cronstrue;
                    console.log("cronstrue", cronstrue.toString(inputValue))
                } else {
                    console.log('Nested input element not found');
                }

                var cronCheckStatus = cronInput.querySelector('div > small');

                if (cronCheckStatus.className == 'cronexpressionError hiden'){
                    data = {
                        cron: nestedInput.value,
                        volume: schVolumeInput.value,
                        time: schDurationInput.value
                    }

                    // Check if schedule list already contains same settings
                    function containsObject(array, obj) {
                        return array.some(element =>
                            Object.keys(obj).every(key =>
                                element.hasOwnProperty(key) && element[key] === obj[key]
                            )
                        );
                    }


                    if (containsObject(scheduleData['pump' + pumpNumber], data)) {
                        console.log("Already in list")
                        }
                    else {
                        console.log(123)
                       // const arr = stringToArray("*/5 * * * *");

                        //print(arr)

                        console.log(`Add ${nestedInput.value} to Pump${pumpNumber} schedule`)
                        scheduleData['pump' + pumpNumber].push(data);
                        console.log(scheduleData['pump' + pumpNumber])
                        updateScheduleList(pumpNumber);

                    }
                }
            }
            else {
                console.log("Volume and Duration empy")
            }
        }

        function updateScheduleList(pumpNumber) {
            const listContainer = document.getElementById('scheduleList' + pumpNumber);
            listContainer.innerHTML = '';
            console.log("Update list fro pump", pumpNumber)

            const table = document.createElement('table');
            table.style.width="500px"
            listContainer.appendChild(table);

            scheduleData['pump' + pumpNumber].forEach((point, index) => {
                console.log(point)
                const row = table.insertRow(-1); // Insert a new row at the end of the table
                                row.setAttribute('style', 'text-align: left');
                // Point cell
                const pointCell = row.insertCell(0);
                pointCell.textContent = `${pumpNumber + 1}`;


                // Schedule cell
                const schCell = row.insertCell(1);
                var cronstrue = window.cronstrue;
                schCell.setAttribute('style', 'white-space: pre;');
                schCell.textContent = `${point["cron"]}`+'\r\n';

                var differentFontSpan = document.createElement('span');
                differentFontSpan.style = 'font-family: Arial, sans-serif;font-size: smaller;font-style: italic;font-stretch: condensed;'; // Specify the font family
                differentFontSpan.textContent = cronstrue.toString(point["cron"]);
                schCell.appendChild(differentFontSpan);

                const volumeCell = row.insertCell(2);
                volumeCell.textContent = `${point["volume"]} ml`;


                const durationCell = row.insertCell(3);
                durationCell.textContent = `${point["time"]} sec`;

                // Delete button cell
                const deleteCell = row.insertCell(4);
                const deleteButton = document.createElement('button');
                deleteButton.style.height = "100%";
                deleteButton.textContent = 'Delete';
                deleteButton.onclick = function() {
                    deleteSchedulePoint(pumpNumber, doser);
                };
                deleteCell.appendChild(deleteButton);
            });
        }

        function deleteSchedulePoint(pumpNumber, pointIndex) {
            scheduleData['pump' + pumpNumber].splice(pointIndex, 1);
            updateScheduleList(pumpNumber);
        }


        // Cookie event
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Cookie update event")
            const numberOfPumps = 9;
            var pumpOptions = ['1', '2', '3', '4', '5', '6', '7', '8', '9'];

            // Dynamically add pump selectors
            const pumpSelector = document.getElementById('pumpSelector');
            for (let i = 1; i <= numberOfPumps; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.text = 'Pump ' + i;
                pumpSelector.appendChild(option);

            }

            // Dynamically add form for Pumps chart
            const container = document.getElementById('scheduleFormsContainer');
            for (let i = 1; i <= numberOfPumps; i++) {
                // Create and append the list for calibration points
                const listDiv = document.createElement('div');
                listDiv.id = `scheduleList${i}`;
                container.appendChild(listDiv);
            }

            console.log("Selected pump ", pumpSelector.value)
            pumpOptions = pumpOptions.filter(option => option !== pumpSelector.value);
            pumpOptions.forEach(pumpNumber => {
                // If the pump is the selected one, show its calibration points list and update the chart
                if (pumpNumber === pumpSelector.value) {
                    document.getElementById('scheduleList' + pumpNumber).style.display = 'block';

                    updateChart(pumpNumber);
                } else {
                    // If the pump is not selected, hide its calibration points list
                    document.getElementById('scheduleList' + pumpNumber).style.display = 'none';

                }
            });



        });

        document.getElementById('pumpSelector').addEventListener('change', function() {
            const pumpNumber = this.value
            console.log("pump selector change ",this.value)
            // Show the relevant form and hide the other
            document.querySelectorAll('.scheduleFormsContainer').forEach(form => form.style.display = 'none');
            document.getElementById('scheduleList' + pumpNumber).style.display = 'block';

            // Show the relevant list of calibration points and hide the others
            document.querySelectorAll('[id^="scheduleList"]').forEach(list => list.style.display = 'none');
            document.getElementById('scheduleList' + pumpNumber).style.display = 'block';

        });


    </script>
</body>
</html>
